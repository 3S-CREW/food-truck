name: Backend Dev Deploy

on:
  push:
    branches: [ "backend" ] # backend 브랜치 푸시 시 동작

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # 이 권한 설정이 없으면 gradlew 실행 시 퍼미션 에러가 날 수 있음
    permissions:
      contents: read

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. JDK 17 설치
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradle 빌드 (테스트 제외 - 속도 및 배포 우선)
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew build -x test

      # 4. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. Docker 이미지 빌드 및 푸시
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/foodtruck-be:dev

      # 6. EC2에 배포
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            mkdir -p ~/foodtruck-server/db/data
            cd ~/foodtruck-server

            cat > docker-compose.dev.yml <<EOF
            version: '3.8'
            services:
              backend:
                container_name: foodtruck-backend
                image: ${{ secrets.DOCKER_USERNAME }}/foodtruck-be:dev
                restart: always
                ports:
                  - "80:8080"
                environment:
                  - SPRING_PROFILES_ACTIVE=dev
                  - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/foodtruck_db?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=UTF-8&serverTimezone=Asia/Seoul
                  - SPRING_DATASOURCE_USERNAME=root
                  - SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
                  - SPRING_REDIS_HOST=redis
                  - SPRING_REDIS_PORT=6379
                depends_on:
                  - mysql
                  - redis
                networks:
                  - foodtruck-network

              redis:
                image: redis:latest
                container_name: foodtruck-redis
                restart: always
                command: redis-server --appendonly yes
                networks:
                  - foodtruck-network

              mysql:
                image: mysql:8.0
                container_name: foodtruck-mysql
                restart: always
                environment:
                  MYSQL_ROOT_PASSWORD: ${{ secrets.DB_PASSWORD }}
                  MYSQL_DATABASE: foodtruck_db
                  TZ: Asia/Seoul
                ports:
                  - "3306:3306"
                command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
                volumes:
                  - ./db/data:/var/lib/mysql
                networks:
                  - foodtruck-network

            networks:
              foodtruck-network:
                driver: bridge
            EOF

            docker pull ${{ secrets.DOCKER_USERNAME }}/foodtruck-be:dev
            
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            docker-compose -f docker-compose.dev.yml down
            docker-compose -f docker-compose.dev.yml up -d

            docker image prune -f